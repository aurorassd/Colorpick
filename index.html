<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能YouTubeプレイヤー Ver.2</title>
    <style>
        /* --- 基本スタイルと配色 --- */
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2c2c2c;
            --primary-color: #0d6efd;
            --primary-color-active: #0b5ed7;
            --text-color: #f0f0f0;
            --text-muted-color: #aaa;
            --border-color: #444;
            --success-color: #198754;
            --danger-color: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 16px;
        }

        /* --- コンテナとレイアウト --- */
        .container {
            width: 100%;
            max-width: 800px;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        h1, h2 {
            text-align: center;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        /* --- 動画プレイヤーエリア --- */
        .player-container {
            margin-bottom: 1rem;
        }
        .player-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 アスペクト比 */
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            transform-origin: center center;
            transition: transform 0.3s ease-in-out;
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- カスタムシークバー --- */
        .seekbar-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
        }
        #seek-bar {
            flex-grow: 1;
        }
        .time-display {
            font-size: 0.9rem;
            color: var(--text-muted-color);
            min-width: 90px;
            text-align: center;
        }

        /* --- 入力とフォーム --- */
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .input-group input[type="text"] {
            flex-grow: 1;
            padding: 0.75rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1rem;
            min-width: 0;
        }
        .input-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* --- ボタン共通スタイル --- */
        button {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
            min-height: 44px; /* モバイルでのタップ領域確保 */
            box-sizing: border-box;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-color-active);
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* --- 操作パネル --- */
        .controls { display: none; } /* 初期状態は非表示 */
        .control-group {
            background-color: var(--surface-color);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        /* --- スライダー共通スタイル --- */
        .slider-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .slider-control input[type="range"] {
            flex-grow: 1;
        }
        .slider-control .value-display {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
        }
        .slider-control .btn-reset {
            background-color: #6c757d;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            min-height: auto;
        }

        /* --- 機能別ボタンスタイル --- */
        #loop-toggle.active {
            background-color: var(--success-color);
        }
        .btn-delete {
            background-color: var(--danger-color);
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            min-height: auto;
        }
        
        /* --- 履歴とお気に入りリスト --- */
        .list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            gap: 0.5rem;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item.clickable:hover { background-color: #3a3a3a; cursor: pointer; }
        .list-item .title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .list-item .timestamp, .list-item .actions { flex-shrink: 0; }
        .list-item .timestamp { font-size: 0.9rem; color: var(--text-muted-color); }
        .ab-selector input { margin-left: 5px; }
        .ab-info { text-align: center; padding: 0.5rem; color: var(--text-muted-color); font-size: 0.9rem; }
        .ab-info span { font-weight: bold; color: var(--text-color); }

    </style>
</head>
<body>

    <div class="container">
        <h1>高機能YouTubeプレイヤー Ver.2</h1>

        <div class="input-group">
            <input type="text" id="video-url" placeholder="YouTube動画のURLまたはIDを入力">
            <button id="load-video">動画を読込</button>
        </div>
        
        <div class="player-container">
            <div id="player-wrapper" class="player-wrapper">
                <div id="player"></div>
            </div>
            <div class="seekbar-container">
                <input type="range" id="seek-bar" value="0" min="0" step="1">
                <div id="time-display" class="time-display">0:00 / 0:00</div>
            </div>
            <p id="video-title" style="text-align: center; font-weight: bold; min-height: 1.2em; margin-top: 0.5rem;"></p>
        </div>

        <div id="controls" class="controls">
            
            <div class="control-group">
                 <h3>基本操作</h3>
                 <div class="control-grid">
                    <button id="skip-backward">-10秒</button>
                    <button id="skip-forward">+10秒</button>
                </div>
            </div>

            <div class="control-group">
                <h3>再生速度</h3>
                <div class="slider-control">
                    <input type="range" id="playback-rate" min="0.1" max="5.0" step="0.1" value="1.0">
                    <span id="rate-value" class="value-display">1.0x</span>
                    <button id="reset-rate" class="btn-reset">リセット</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>表示倍率</h3>
                <div class="slider-control">
                    <input type="range" id="zoom-slider" min="1.0" max="2.0" step="0.05" value="1.0">
                    <span id="zoom-value" class="value-display">1.0x</span>
                    <button id="reset-zoom" class="btn-reset">リセット</button>
                </div>
            </div>

            <div class="control-group">
                <h3>AB間ループ再生</h3>
                <div class="control-grid">
                    <button id="add-favorite">現在位置を記録</button>
                    <button id="loop-toggle">ループ再生OFF</button>
                </div>
                <div id="ab-info" class="ab-info">A点とB点を選択してください</div>
                <div id="favorites-list" class="list-container" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <h2>再生履歴</h2>
        <div id="history-list" class="list-container">
            <p style="text-align: center; color: var(--text-muted-color);">履歴はありません</p>
        </div>
    </div>

    <script>
        // --- 1. グローバル変数と初期設定 ---
        let player;
        let history = [];
        let favorites = [];
        let loopInterval, timeUpdateInterval;
        let isLooping = false;
        let isSeeking = false;
        let loopA = -1, loopB = -1;
        let isPlayerReady = false;
        const MAX_HISTORY_COUNT = 10;

        // --- 2. YouTube IFrame Player APIのセットアップ ---
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        function onYouTubeIframeAPIReady() {}

        function createPlayer(videoId, startSeconds = 0) {
            if (player) player.destroy();
            player = new YT.Player('player', {
                videoId: videoId,
                playerVars: { 'playsinline': 1, 'rel': 0, 'start': Math.floor(startSeconds) },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        
        function onPlayerReady(event) {
            isPlayerReady = true;
            document.getElementById('controls').style.display = 'block';
            updateVideoTitle();
            loadFavorites();
            updateFavoritesUI();
            
            const duration = player.getDuration();
            document.getElementById('seek-bar').max = duration;

            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            clearInterval(timeUpdateInterval);
            if (event.data == YT.PlayerState.PLAYING) {
                timeUpdateInterval = setInterval(updateTime, 250);
            } else {
                saveCurrentVideoHistory();
            }
        }
        
        // --- 3. UIイベントリスナー ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            updateHistoryUI();

            document.getElementById('load-video').addEventListener('click', loadVideoFromInput);
            document.getElementById('skip-backward').addEventListener('click', () => skip(-10));
            document.getElementById('skip-forward').addEventListener('click', () => skip(10));

            // 再生速度スライダー
            const rateSlider = document.getElementById('playback-rate');
            rateSlider.addEventListener('input', () => setPlaybackRate(rateSlider.value));
            document.getElementById('reset-rate').addEventListener('click', () => {
                rateSlider.value = 1.0;
                setPlaybackRate(1.0);
            });
            
            // ズームスライダー
            const zoomSlider = document.getElementById('zoom-slider');
            zoomSlider.addEventListener('input', () => setZoom(zoomSlider.value));
            document.getElementById('reset-zoom').addEventListener('click', () => {
                zoomSlider.value = 1.0;
                setZoom(1.0);
            });
            
            document.getElementById('add-favorite').addEventListener('click', addFavorite);
            document.getElementById('loop-toggle').addEventListener('click', toggleLoop);
            
            // シークバー
            const seekBar = document.getElementById('seek-bar');
            seekBar.addEventListener('mousedown', () => { isSeeking = true; });
            seekBar.addEventListener('touchstart', () => { isSeeking = true; });
            seekBar.addEventListener('input', () => {
                if(isPlayerReady) player.seekTo(seekBar.value, false);
            });
            seekBar.addEventListener('change', () => {
                if(isPlayerReady) player.seekTo(seekBar.value, true);
                isSeeking = false;
            });
            seekBar.addEventListener('mouseup', () => { isSeeking = false; });
            seekBar.addEventListener('touchend', () => { isSeeking = false; });
            
            window.addEventListener('pagehide', saveCurrentVideoHistory);
        });
        
        // --- 4. 主要機能 ---
        function loadVideoFromInput() {
            const url = document.getElementById('video-url').value;
            const videoId = parseVideoId(url);
            if (videoId) createPlayer(videoId);
            else alert('有効なYouTube URLまたは動画IDを入力してください。');
        }

        function parseVideoId(url) {
            if (!url) return null;
            let videoId = url.split('v=')[1];
            if (videoId) {
                const ampersandPosition = videoId.indexOf('&');
                if (ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);
                return videoId;
            }
            if (url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
            return null;
        }

        function skip(seconds) {
            if (!isPlayerReady) return;
            player.seekTo(player.getCurrentTime() + seconds, true);
        }

        function setPlaybackRate(rate) {
            if (!isPlayerReady) return;
            player.setPlaybackRate(parseFloat(rate));
            document.getElementById('rate-value').textContent = `${parseFloat(rate).toFixed(1)}x`;
        }

        function setZoom(scale) {
            document.getElementById('player-wrapper').style.transform = `scale(${scale})`;
            document.getElementById('zoom-value').textContent = `${parseFloat(scale).toFixed(1)}x`;
        }
        
        function updateVideoTitle() {
            if (!isPlayerReady) return;
            document.getElementById('video-title').textContent = player.getVideoData().title;
        }

        function updateTime() {
            if (!isPlayerReady || !player.getCurrentTime) return;
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            if (!isSeeking) {
                document.getElementById('seek-bar').value = currentTime;
            }
            document.getElementById('time-display').textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            saveCurrentVideoHistory(); // 定期的に履歴保存
        }

        // --- 5. 再生履歴機能 ---
        function saveCurrentVideoHistory() {
            if (!isPlayerReady || !player.getVideoData || !player.getVideoData().video_id) return;
            
            const videoData = player.getVideoData();
            const newEntry = {
                videoId: videoData.video_id,
                title: videoData.title,
                timestamp: player.getCurrentTime(),
            };
            
            history = history.filter(item => item.videoId !== newEntry.videoId);
            history.unshift(newEntry);
            if (history.length > MAX_HISTORY_COUNT) history.pop();
            
            localStorage.setItem('youtubeHistory', JSON.stringify(history));
            updateHistoryUI();
        }

        function loadHistory() {
            const storedHistory = localStorage.getItem('youtubeHistory');
            if (storedHistory) history = JSON.parse(storedHistory);
        }

        function updateHistoryUI() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            
            if (history.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">履歴はありません</p>';
                return;
            }

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item clickable';
                div.innerHTML = `<span class="title">${item.title}</span><span class="timestamp">${formatTime(item.timestamp)}</span>`;
                div.addEventListener('click', () => {
                    if (player && player.getVideoData().video_id === item.videoId) {
                        player.seekTo(item.timestamp, true);
                        player.playVideo();
                    } else {
                        createPlayer(item.videoId, item.timestamp);
                    }
                });
                listEl.appendChild(div);
            });
        }
        
        // --- 6. AB間ループ再生機能 ---
        function loadFavorites() {
            if (!isPlayerReady) return;
            const videoId = player.getVideoData().video_id;
            favorites = JSON.parse(localStorage.getItem(`youtubeFavorites_${videoId}`) || '[]');
        }
        
        function saveFavorites() {
            if (!isPlayerReady) return;
            const videoId = player.getVideoData().video_id;
            localStorage.setItem(`youtubeFavorites_${videoId}`, JSON.stringify(favorites));
        }

        function addFavorite() {
            if (!isPlayerReady) return;
            const currentTime = player.getCurrentTime();
            if (!favorites.some(fav => fav.time === currentTime)) {
                favorites.push({ time: currentTime });
                favorites.sort((a, b) => a.time - b.time);
                saveFavorites();
                updateFavoritesUI();
            }
        }
        
        function deleteFavorite(timeToDelete) {
            favorites = favorites.filter(fav => fav.time !== timeToDelete);
            saveFavorites();
            // 削除されたポイントがA or Bに設定されていたらリセット
            if (loopA === timeToDelete || loopB === timeToDelete) {
                loopA = -1;
                loopB = -1;
                if(isLooping) toggleLoop(); // ループ中なら停止
                updateLoopPoints();
            }
            updateFavoritesUI();
        }

        function updateFavoritesUI() {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';

            if (favorites.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">記録されたポイントはありません</p>';
                return;
            }

            favorites.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span class="timestamp">${formatTime(fav.time)}</span>
                    <div class="ab-selector">
                        <label>A<input type="radio" name="loopPointA" value="${fav.time}"></label>
                        <label>B<input type="radio" name="loopPointB" value="${fav.time}"></label>
                    </div>
                    <div class="actions">
                        <button class="btn-delete" data-time="${fav.time}">削除</button>
                    </div>
                `;
                listEl.appendChild(div);
            });

            document.querySelectorAll('input[name="loopPointA"], input[name="loopPointB"]').forEach(radio => {
                radio.addEventListener('change', updateLoopPoints);
            });
            document.querySele
