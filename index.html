<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム カラーミキサー v2.8 (256色パレット)</title> <!-- バージョン更新 -->
    <style>
        /* --- 全体的なスタイル (変更なし) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #333; }

        /* --- 結果表示ヘッダー (変更なし) --- */
        #resultHeader { display: none; position: sticky; top: 0; left: 0; width: 100%; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); padding: 8px 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); z-index: 1000; box-sizing: border-box; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        #resultHeaderSwatch { width: 28px; height: 28px; border-radius: 4px; border: 1px solid #ccc; flex-shrink: 0; display: inline-block; }
        #resultHeaderHex { font-weight: 600; font-size: 1em; flex-grow: 1; text-align: left; color: #333; transition: color 0.3s ease; user-select: none; }

        /* --- メインコンテナ (変更なし) --- */
        .container { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); display: flex; flex-wrap: wrap; gap: 30px; max-width: 1100px; width: 100%; margin: 20px; box-sizing: border-box; position: relative; }

        /* --- タイトル周り (変更なし) --- */
        .title-container { width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 25px; position: relative; }
        h1 { text-align: center; margin: 0; color: #1a1a1a; font-weight: 600; font-size: 1.8em; flex-grow: 1; }
        #showPaletteButton { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: 1px solid #ccc; border-radius: 50%; width: 36px; height: 36px; font-size: 1.5em; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, border-color 0.2s; color: #555; line-height: 1; }
        #showPaletteButton:hover { background-color: #f0f0f0; border-color: #aaa; }

        /* --- メインレイアウト (変更なし) --- */
        .main-content { flex: 2 1 500px; display: flex; flex-direction: column; gap: 20px; }
        .sidebar { flex: 1 1 300px; display: flex; flex-direction: column; gap: 20px; }

        /* --- 色設定エリア (変更なし) --- */
        .color-settings { display: flex; flex-direction: column; gap: 20px; }
        .color-control { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #fdfdfd; display: grid; grid-template-columns: auto 1fr auto; grid-template-rows: auto auto auto; gap: 10px 15px; align-items: center; transition: box-shadow 0.2s ease-in-out; }
        .color-control:focus-within { box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
        .color-control label { font-weight: 600; grid-column: 1 / 2; grid-row: 1 / 2; color: #444; }
        .color-picker-container { grid-column: 2 / 3; grid-row: 1 / 2; display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
        .color-control input[type="color"] { width: 40px; height: 40px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; padding: 0; background-color: transparent; -webkit-appearance: none; -moz-appearance: none; appearance: none; vertical-align: middle; flex-shrink: 0; }
        .color-control input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-control input[type="color"]::-webkit-color-swatch { border: none; border-radius: 5px; }
        .color-control input[type="color"]::-moz-color-swatch { border: none; border-radius: 5px; }
        .hex-input { width: 80px; height: 30px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; text-transform: uppercase; outline: none; transition: border-color 0.2s; box-sizing: border-box; vertical-align: middle; flex-shrink: 0; }
        .hex-input:focus { border-color: #007bff; }
        .hex-input.invalid { border-color: red; box-shadow: 0 0 0 1px red; }
        .paste-button { width: 30px; height: 30px; padding: 0; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; border-radius: 4px; cursor: pointer; font-size: 1em; line-height: 28px; text-align: center; transition: background-color 0.2s, border-color 0.2s; vertical-align: middle; flex-shrink: 0; }
        .paste-button:hover { background-color: #e9ecef; border-color: #bbb; }
        .paste-button:active { background-color: #d6dadf; }
        .paste-button:disabled { cursor: not-allowed; opacity: 0.6; background-color: #eee; }
        .eyedropper-button { width: 30px; height: 30px; padding: 0; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; border-radius: 4px; cursor: pointer; font-size: 1.2em; line-height: 28px; text-align: center; transition: background-color 0.2s, border-color 0.2s; vertical-align: middle; flex-shrink: 0; position: relative; }
        .eyedropper-button:hover { background-color: #e9ecef; border-color: #bbb; }
        .eyedropper-button:active { background-color: #d6dadf; }
        .eyedropper-button:disabled { cursor: not-allowed; opacity: 0.6; background-color: #eee; }
        .eyedropper-button[data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; white-space: nowrap; z-index: 10; margin-bottom: 5px; pointer-events: none; }
        .enable-switch-container { grid-column: 3 / 4; grid-row: 1 / 2; display: flex; align-items: center; justify-content: flex-end; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-track { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider-track:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider-track { background-color: #007bff; }
        input:checked + .slider-track:before { transform: translateX(20px); }
        .slider-container { grid-column: 1 / 4; grid-row: 2 / 3; display: flex; align-items: center; gap: 15px; }
        .color-control input[type="range"] { flex-grow: 1; cursor: pointer; height: 8px; border-radius: 4px; background: linear-gradient(to right, #e0e0e0, #e0e0e0); appearance: none; outline: none; transition: background 0.2s ease; }
        .color-control input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: #007bff; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .color-control input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: #007bff; border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .percentage-display { font-weight: 600; min-width: 45px; text-align: right; color: #555; }
        .quick-settings { grid-column: 1 / 4; grid-row: 3 / 4; display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .quick-settings button { font-size: 0.75em; padding: 3px 6px; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; line-height: 1; }
        .quick-settings button:hover { background-color: #e9ecef; border-color: #bbb; }
        .quick-settings button:active { background-color: #d6dadf; }

        /* --- 結果表示エリア (変更なし) --- */
        .result-area { display: flex; flex-direction: column; gap: 15px; }
        .result-display { min-height: 150px; border: 1px solid #ccc; border-radius: 8px; background-color: #ffffff; display: flex; justify-content: center; align-items: center; text-align: center; transition: background-color 0.3s ease; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); position: relative; }
        .result-text { background-color: rgba(255, 255, 255, 0.85); padding: 12px 18px; border-radius: 6px; font-size: 1.2em; font-weight: 600; color: #333; transition: color 0.3s ease, background-color 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: default; user-select: none; }
        .save-button { padding: 12px 20px; font-size: 1em; font-weight: 600; color: #fff; background-color: #28a745; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; width: 100%; box-sizing: border-box; }
        .save-button:hover { background-color: #218838; }
        .save-button:active { background-color: #1e7e34; }

        /* --- 保存リストエリア (変更なし) --- */
        .saved-colors-section { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-grow: 1; min-height: 200px; overflow: hidden; }
        .saved-colors-section h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; font-weight: 600; color: #333; text-align: center; flex-shrink: 0; }
        #savedColorsList { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; }
        #savedColorsList li { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s ease; }
        #savedColorsList li:last-child { border-bottom: none; }
        #savedColorsList li:hover { background-color: #f0f8ff; }
        .saved-color-swatch { width: 30px; height: 30px; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; flex-shrink: 0; }
        .saved-color-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .saved-color-hex { font-weight: 600; font-size: 0.95em; color: #333; white-space: nowrap; }
        .saved-color-details { font-size: 0.8em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- カラーパレットモーダル --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); max-width: 90%; /* 幅を可変に */ width: auto; /* コンテンツに合わせる */ max-height: 85vh; display: flex; flex-direction: column; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-title { font-size: 1.4em; font-weight: 600; margin: 0; }
        .modal-close-button { background: none; border: none; font-size: 1.8em; font-weight: bold; color: #888; cursor: pointer; padding: 0 5px; line-height: 1; }
        .modal-close-button:hover { color: #333; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .palette-section { margin-bottom: 25px; }
        .palette-section:last-child { margin-bottom: 0; }
        .palette-section h3 { font-size: 1.1em; font-weight: 600; color: #555; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .palette-grid { display: grid; /* グリッドを基本に */ /* ★ カラム数はJSで設定 */ gap: 6px; /* ギャップ縮小 */ padding: 5px; }
        /* ★ グリッドの特定のカラム数を設定 (JavaScriptからクラスで制御) */
        .palette-grid-cols-8 { grid-template-columns: repeat(8, minmax(20px, 1fr)); } /* 16色用 */
        .palette-grid-cols-18 { grid-template-columns: repeat(18, minmax(20px, 1fr)); } /* 216色用 (36x6) - PC向け */
        .palette-grid-cols-12 { grid-template-columns: repeat(12, minmax(20px, 1fr)); } /* 216色用 - モバイル向け */
        .palette-grid-cols-6 { grid-template-columns: repeat(6, minmax(20px, 1fr)); } /* グレースケール用 */

        .palette-color-swatch { width: 100%; padding-bottom: 100%; height: 0; border-radius: 4px; border: 1px solid #eee; cursor: pointer; position: relative; transition: transform 0.1s ease, box-shadow 0.1s ease; box-sizing: border-box; }
        .palette-color-swatch:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); z-index: 1; }

        /* --- コピー通知 (変更なし) --- */
        #copyNotification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 5px; font-size: 0.9em; z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; }
        #copyNotification.visible { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }

        /* --- レスポンシブ対応 --- */
        @media (max-width: 992px) { #resultHeader { display: flex; } .container { flex-direction: column; max-width: 100%; margin: 0; padding: 15px; border-radius: 0; box-shadow: none; gap: 20px; } body { padding: 0; } .title-container { margin-bottom: 15px; } h1 { margin-top: 0; font-size: 1.6em; } #showPaletteButton { width: 32px; height: 32px; font-size: 1.3em; } .main-content, .sidebar { flex-basis: auto; width: 100%; } .saved-colors-section { min-height: 250px; max-height: 40vh; } .result-display { min-height: 100px; } .result-text { font-size: 1.1em; padding: 10px 15px; } .modal-content { max-width: 95%; width: auto; padding: 20px; } .modal-title { font-size: 1.2em; } /* モバイルでのパレットカラム数を調整 */ .palette-grid-cols-18 { grid-template-columns: repeat(12, minmax(20px, 1fr)); } /* Webセーフ */ .palette-grid-cols-8 { grid-template-columns: repeat(8, minmax(20px, 1fr)); } /* 16色 */ .palette-grid-cols-6 { grid-template-columns: repeat(6, minmax(20px, 1fr)); } /* グレー */ }
        @media (max-width: 768px) { .color-control { grid-template-columns: auto 1fr; grid-template-rows: auto auto auto auto; gap: 8px 10px; } .color-control label { grid-row: 1 / 2; grid-column: 1 / 2; } .color-picker-container { grid-row: 1 / 2; grid-column: 2 / 3; justify-content: flex-start; } .hex-input { width: 70px; } .enable-switch-container { grid-row: 2 / 3; grid-column: 1 / 3; justify-content: flex-start; padding-top: 5px; } .slider-container { grid-row: 3 / 4; grid-column: 1 / 3; } .quick-settings { grid-row: 4 / 5; grid-column: 1 / 3; } .save-button { padding: 10px 15px; font-size: 0.95em; } .saved-colors-section { padding: 15px; max-height: 35vh; } .saved-colors-section h2 { font-size: 1.2em; } #savedColorsList li { padding: 8px 12px; } .saved-color-swatch { width: 25px; height: 25px; margin-right: 10px; } .saved-color-hex { font-size: 0.9em; } .saved-color-details { font-size: 0.75em; } }
    </style>
</head>
<body>
    <!-- 結果表示ヘッダー -->
    <div id="resultHeader">
        <span id="resultHeaderSwatch"></span>
        <span id="resultHeaderHex">#FFFFFF</span>
    </div>

    <div class="container">
        <!-- タイトルとパレットボタン -->
        <div class="title-container">
             <h1>リアルタイム カラーミキサー v2.8 (256色パレット)</h1>
             <button id="showPaletteButton" title="カラーパレット表示">🎨</button>
        </div>

        <!-- メインコンテンツ (色設定) -->
        <div class="main-content">
            <div class="color-settings">
                <!-- Color Controls 1-5 (ペーストボタン含む) -->
                <div class="color-control" id="colorControl1"><label for="color1">色 1:</label><div class="color-picker-container"><input type="color" id="color1" value="#ff0000"><input type="text" class="hex-input" id="hexInput1" value="#FF0000" maxlength="7"><button class="paste-button" data-target-hex-input="hexInput1" title="ペースト">📋</button><button class="eyedropper-button" data-target-color-input="color1" title="スポイト" data-tooltip="スポイト">💧</button></div><div class="enable-switch-container"><label class="switch"><input type="checkbox" id="enable1" checked><span class="slider-track"></span></label></div><div class="slider-container"><input type="range" id="ratio1" min="0" max="100" value="100" class="ratio-slider"><span class="percentage-display" id="ratioDisplay1">100%</span></div><div class="quick-settings" id="quickSettings1"></div></div>
                <div class="color-control" id="colorControl2"><label for="color2">色 2:</label><div class="color-picker-container"><input type="color" id="color2" value="#0000ff"><input type="text" class="hex-input" id="hexInput2" value="#0000FF" maxlength="7"><button class="paste-button" data-target-hex-input="hexInput2" title="ペースト">📋</button><button class="eyedropper-button" data-target-color-input="color2" title="スポイト" data-tooltip="スポイト">💧</button></div><div class="enable-switch-container"><label class="switch"><input type="checkbox" id="enable2"><span class="slider-track"></span></label></div><div class="slider-container"><input type="range" id="ratio2" min="0" max="100" value="0" class="ratio-slider"><span class="percentage-display" id="ratioDisplay2">0%</span></div><div class="quick-settings" id="quickSettings2"></div></div>
                <div class="color-control" id="colorControl3"><label for="color3">色 3:</label><div class="color-picker-container"><input type="color" id="color3" value="#00ff00"><input type="text" class="hex-input" id="hexInput3" value="#00FF00" maxlength="7"><button class="paste-button" data-target-hex-input="hexInput3" title="ペースト">📋</button><button class="eyedropper-button" data-target-color-input="color3" title="スポイト" data-tooltip="スポイト">💧</button></div><div class="enable-switch-container"><label class="switch"><input type="checkbox" id="enable3"><span class="slider-track"></span></label></div><div class="slider-container"><input type="range" id="ratio3" min="0" max="100" value="0" class="ratio-slider"><span class="percentage-display" id="ratioDisplay3">0%</span></div><div class="quick-settings" id="quickSettings3"></div></div>
                <div class="color-control" id="colorControl4"><label for="color4">色 4:</label><div class="color-picker-container"><input type="color" id="color4" value="#ffff00"><input type="text" class="hex-input" id="hexInput4" value="#FFFF00" maxlength="7"><button class="paste-button" data-target-hex-input="hexInput4" title="ペースト">📋</button><button class="eyedropper-button" data-target-color-input="color4" title="スポイト" data-tooltip="スポイト">💧</button></div><div class="enable-switch-container"><label class="switch"><input type="checkbox" id="enable4"><span class="slider-track"></span></label></div><div class="slider-container"><input type="range" id="ratio4" min="0" max="100" value="0" class="ratio-slider"><span class="percentage-display" id="ratioDisplay4">0%</span></div><div class="quick-settings" id="quickSettings4"></div></div>
                <div class="color-control" id="colorControl5"><label for="color5">色 5:</label><div class="color-picker-container"><input type="color" id="color5" value="#ff00ff"><input type="text" class="hex-input" id="hexInput5" value="#FF00FF" maxlength="7"><button class="paste-button" data-target-hex-input="hexInput5" title="ペースト">📋</button><button class="eyedropper-button" data-target-color-input="color5" title="スポイト" data-tooltip="スポイト">💧</button></div><div class="enable-switch-container"><label class="switch"><input type="checkbox" id="enable5"><span class="slider-track"></span></label></div><div class="slider-container"><input type="range" id="ratio5" min="0" max="100" value="0" class="ratio-slider"><span class="percentage-display" id="ratioDisplay5">0%</span></div><div class="quick-settings" id="quickSettings5"></div></div>
            </div>
        </div>

        <!-- サイドバー (結果表示 + 保存リスト) -->
        <div class="sidebar">
             <div class="result-area">
                 <div class="result-display" id="resultDisplay">
                     <span class="result-text" id="resultText">#ff0000</span>
                 </div>
                 <button class="save-button" id="saveColorButton">現在の色を保存</button>
            </div>
            <div class="saved-colors-section">
                <h2>保存した色</h2>
                <ul id="savedColorsList"></ul>
            </div>
        </div>
    </div>

    <!-- カラーパレットモーダル -->
    <div id="colorPaletteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">カラーパレット</h2>
                <button id="closePaletteButton" class="modal-close-button" title="閉じる">×</button>
            </div>
            <div class="modal-body">
                 <!-- ★ 256色インデックスカラーセクション -->
                 <div class="palette-section">
                     <h3>インデックスカラー (256色)</h3>
                     <!-- グリッドコンテナはセクションごとに分ける -->
                     <div id="indexColorGrid256" class="palette-grid">
                         <!-- 256色がここに動的に追加されます -->
                     </div>
                 </div>
                 <!-- Webセーフカラーセクション (オプションとして残す or 削除) -->
                 <!--
                 <div class="palette-section">
                     <h3>Webセーフカラー (216色)</h3>
                     <div id="webSafePaletteGrid" class="palette-grid">
                     </div>
                 </div>
                 -->
            </div>
        </div>
    </div>

    <!-- コピー通知 -->
    <div id="copyNotification">コピーしました！</div>


    <script>
        // --- グローバル定数, DOM要素取得 ---
        const MAX_COLORS = 5;
        const LOCAL_STORAGE_KEY = 'savedColorMixes_v2';
        const colorControls = [];
        for (let i = 1; i <= MAX_COLORS; i++) { colorControls.push({ id: i, container: document.getElementById(`colorControl${i}`), colorInput: document.getElementById(`color${i}`), hexInput: document.getElementById(`hexInput${i}`), enableCheckbox: document.getElementById(`enable${i}`), ratioSlider: document.getElementById(`ratio${i}`), ratioDisplay: document.getElementById(`ratioDisplay${i}`), quickSettingsContainer: document.getElementById(`quickSettings${i}`) }); }
        const resultDisplay = document.getElementById('resultDisplay');
        const resultText = document.getElementById('resultText');
        const saveColorButton = document.getElementById('saveColorButton');
        const savedColorsListElement = document.getElementById('savedColorsList');
        const eyedropperButtons = document.querySelectorAll('.eyedropper-button');
        const pasteButtons = document.querySelectorAll('.paste-button');
        const resultHeader = document.getElementById('resultHeader');
        const resultHeaderSwatch = document.getElementById('resultHeaderSwatch');
        const resultHeaderHex = document.getElementById('resultHeaderHex');
        const showPaletteButton = document.getElementById('showPaletteButton');
        const colorPaletteModal = document.getElementById('colorPaletteModal');
        const closePaletteButton = document.getElementById('closePaletteButton');
        const indexColorGrid256 = document.getElementById('indexColorGrid256'); // ★ 256色グリッド
        // const webSafePaletteGrid = document.getElementById('webSafePaletteGrid'); // オプション
        const copyNotification = document.getElementById('copyNotification');

        // --- 状態管理 ---
        let savedColorMixes = [];
        let copyNotifyTimeout = null;
        let xterm256HexCache = null; // ★ 256色パレットのキャッシュ

        // --- イベントリスナーの設定 (変更なし) ---
        colorControls.forEach((control) => { control.colorInput.addEventListener('input', () => { handleColorInputChange(control); }); control.hexInput.addEventListener('input', () => { handleHexInputChange(control); }); control.enableCheckbox.addEventListener('change', mixColorsAndUpdateUI); control.ratioSlider.addEventListener('input', () => { handleSliderInputChange(control); }); });
        saveColorButton.addEventListener('click', saveCurrentColorMix);
        savedColorsListElement.addEventListener('click', (event) => { handleSavedListClick(event); });
        eyedropperButtons.forEach(button => { /* ... スポイトリスナー ... */ const targetInputId = button.dataset.targetColorInput; const targetControl = colorControls.find(c => c.colorInput.id === targetInputId); if (!targetControl || !targetControl.colorInput || !targetControl.hexInput) { console.error(`Target control elements not found for ${targetInputId}`); button.disabled = true; return; } if (!('EyeDropper' in window)) { const msg = "スポイト非対応ブラウザです"; button.disabled = true; button.title = msg; button.dataset.tooltip = msg; return; } button.addEventListener('click', async () => { if (button.disabled) return; try { const eyedropper = new EyeDropper(); const result = await eyedropper.open(); if (result && result.sRGBHex) { targetControl.colorInput.value = result.sRGBHex; targetControl.hexInput.value = result.sRGBHex.toUpperCase(); handleColorInputChange(targetControl); } } catch (error) { if (error.name !== 'AbortError') { console.error("EyeDropper error:", error); } } }); });
        pasteButtons.forEach(button => { /* ... ペーストリスナー ... */ const targetInputId = button.dataset.targetHexInput; const targetHexInput = document.getElementById(targetInputId); const targetControl = colorControls.find(c => c.hexInput.id === targetInputId); if (!targetHexInput || !targetControl) { console.error(`Paste target not found: ${targetInputId}`); button.disabled = true; return; } if (!navigator.clipboard || !navigator.clipboard.readText) { button.disabled = true; button.title = "クリップボード読取非対応"; return; } button.addEventListener('click', async () => { try { const text = await navigator.clipboard.readText(); if (text) { targetHexInput.value = text; handleHexInputChange(targetControl); } } catch (err) { console.error('Failed to read clipboard contents: ', err); showCopyNotification("ペースト失敗", true); } }); });
        showPaletteButton.addEventListener('click', openPaletteModal);
        closePaletteButton.addEventListener('click', closePaletteModal);
        colorPaletteModal.addEventListener('click', (event) => { if (event.target === colorPaletteModal) { closePaletteModal(); } });
        colorPaletteModal.addEventListener('click', (event) => { /* ... パレット内クリック (コピー処理) ... */ const swatch = event.target.closest('.palette-color-swatch'); if (swatch && swatch.dataset.hex) { copyToClipboard(swatch.dataset.hex); } });

        // --- ヘルパー関数 (色関連以外は変更なし) ---
        function isValidHexCode(hex) { return /^#?([a-f\d]{3}|[a-f\d]{6})$/i.test(hex); }
        function normalizeHexCode(hex) { if (!isValidHexCode(hex)) return null; let code = hex.startsWith('#') ? hex.slice(1) : hex; if (code.length === 3) { code = code.split('').map(char => char + char).join(''); } return `#${code.toUpperCase()}`; }
        function handleColorInputChange(control) { if (!control || !control.colorInput || !control.hexInput) return; const newColor = control.colorInput.value.toUpperCase(); control.hexInput.value = newColor; control.hexInput.classList.remove('invalid'); updateSliderBackground(control); mixColorsAndUpdateUI(); }
        function handleHexInputChange(control) { if (!control || !control.colorInput || !control.hexInput) return; const inputText = control.hexInput.value; if (isValidHexCode(inputText)) { const normalizedHex = normalizeHexCode(inputText); if (normalizedHex) { control.colorInput.value = normalizedHex; control.hexInput.classList.remove('invalid'); updateSliderBackground(control); mixColorsAndUpdateUI(); } else { control.hexInput.classList.add('invalid'); } } else { control.hexInput.classList.add('invalid'); } }
        function handleSliderInputChange(control) { if (!control) return; updateRatioDisplay(control); updateSliderBackground(control); mixColorsAndUpdateUI(); }
        function handleSavedListClick(event) { const listItem = event.target.closest('li'); if (listItem && listItem.dataset.index) { const index = parseInt(listItem.dataset.index, 10); restoreColorMix(index); } }
        function hexToRgb(hex) { const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i; hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b); const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        function rgbToHex(r, g, b) { const clamp = (val) => Math.min(255, Math.max(0, Math.round(val))); const toHex = (c) => clamp(c).toString(16).padStart(2, '0'); return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }
        function mixColors() { let totalRatio = 0; let mixedR = 0, mixedG = 0, mixedB = 0; const activeColorsData = getActiveColorSettings(); activeColorsData.forEach(({ ratio }) => { totalRatio += ratio; }); if (activeColorsData.length === 0 || totalRatio === 0) return { r: 255, g: 255, b: 255 }; activeColorsData.forEach(({ rgb, ratio }) => { const weight = ratio / totalRatio; mixedR += rgb.r * weight; mixedG += rgb.g * weight; mixedB += rgb.b * weight; }); return { r: mixedR, g: mixedG, b: mixedB }; }
        function getActiveColorSettings() { const activeSettings = []; colorControls.forEach(control => { if (control.enableCheckbox.checked) { const rgb = hexToRgb(control.colorInput.value); const ratio = parseInt(control.ratioSlider.value, 10); if (rgb && ratio > 0) { activeSettings.push({ controlId: control.id, rgb, ratio, colorHex: control.colorInput.value }); } } }); return activeSettings; }
        function getCurrentSettingsSnapshot() { return colorControls.map(control => ({ id: control.id, color: control.colorInput.value, enabled: control.enableCheckbox.checked, ratio: parseInt(control.ratioSlider.value, 10) })); }
        function getContrastingTextColor(r, g, b) { const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.6 ? '#333' : '#fff'; }
        function updateSliderBackground(control) { if (!control || !control.colorInput || !control.ratioSlider) return; const color = control.colorInput.value; const percentage = control.ratioSlider.value; control.ratioSlider.style.background = `linear-gradient(to right, ${color} ${percentage}%, #e0e0e0 ${percentage}%)`; }
        function updateAllSliderBackgrounds() { colorControls.forEach(updateSliderBackground); }
        function updateRatioDisplay(control) { if (!control || !control.ratioSlider || !control.ratioDisplay) return; control.ratioDisplay.textContent = `${control.ratioSlider.value}%`; }
        function mixColorsAndUpdateUI() { const mixedRgb = mixColors(); const finalHexColor = rgbToHex(mixedRgb.r, mixedRgb.g, mixedRgb.b); const textColor = getContrastingTextColor(mixedRgb.r, mixedRgb.g, mixedRgb.b); resultDisplay.style.backgroundColor = finalHexColor; resultText.textContent = finalHexColor.toUpperCase(); resultText.style.color = textColor; resultText.style.backgroundColor = textColor === '#333' ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.5)'; if (resultHeaderSwatch && resultHeaderHex) { resultHeaderSwatch.style.backgroundColor = finalHexColor; resultHeaderHex.textContent = finalHexColor.toUpperCase(); const headerTextColor = '#333'; resultHeaderHex.style.color = headerTextColor; } }
        function createQuickSettingButtons(control) { if (!control || !control.quickSettingsContainer) return; const percentages = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]; control.quickSettingsContainer.innerHTML = ''; percentages.forEach(p => { const button = document.createElement('button'); button.textContent = `${p}%`; button.type = 'button'; button.addEventListener('click', () => { if (!control.ratioSlider) return; control.ratioSlider.value = p; handleSliderInputChange(control); }); control.quickSettingsContainer.appendChild(button); }); }

        // --- 保存と復元機能 (変更なし) ---
        function loadSavedMixes() { try { const savedData = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedData) { savedColorMixes = JSON.parse(savedData); savedColorMixes.sort((a, b) => b.timestamp - a.timestamp); } else { savedColorMixes = []; } } catch (error) { console.error("保存された色の読み込みに失敗しました:", error); savedColorMixes = []; } }
        function saveCurrentColorMix() { const currentSettings = getCurrentSettingsSnapshot(); const resultColor = resultText.textContent; const newMix = { timestamp: Date.now(), resultColor: resultColor, settings: currentSettings }; savedColorMixes.unshift(newMix); try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedColorMixes)); updateSavedListUI(); } catch (error) { console.error("色の保存に失敗しました:", error); savedColorMixes.shift(); alert("色の保存に失敗しました。ストレージの空き容量を確認してください。"); } }
        function updateSavedListUI() { savedColorsListElement.innerHTML = ''; if (savedColorMixes.length === 0) { const placeholder = document.createElement('li'); placeholder.textContent = "保存された色はありません"; placeholder.style.cssText = 'text-align: center; color: #888; cursor: default; border-bottom: none;'; savedColorsListElement.appendChild(placeholder); return; } savedColorMixes.forEach((mix, index) => { const listItem = document.createElement('li'); listItem.dataset.index = index; const swatch = document.createElement('span'); swatch.className = 'saved-color-swatch'; swatch.style.backgroundColor = mix.resultColor; const infoDiv = document.createElement('div'); infoDiv.className = 'saved-color-info'; const hexSpan = document.createElement('span'); hexSpan.className = 'saved-color-hex'; hexSpan.textContent = mix.resultColor; const detailsSpan = document.createElement('span'); detailsSpan.className = 'saved-color-details'; const activeDetails = mix.settings.filter(s => s.enabled && s.ratio > 0).map(s => `色${s.id}(${s.color}):${s.ratio}%`).join(', '); detailsSpan.textContent = activeDetails || "（単色または無効）"; detailsSpan.title = activeDetails; infoDiv.appendChild(hexSpan); infoDiv.appendChild(detailsSpan); listItem.appendChild(swatch); listItem.appendChild(infoDiv); savedColorsListElement.appendChild(listItem); }); }
        function restoreColorMix(index) { if (index < 0 || index >= savedColorMixes.length) return; const mixToRestore = savedColorMixes[index]; mixToRestore.settings.forEach(savedSetting => { const control = colorControls.find(c => c.id === savedSetting.id); if (control && control.colorInput && control.hexInput && control.enableCheckbox && control.ratioSlider) { const colorHex = savedSetting.color; control.colorInput.value = colorHex; control.hexInput.value = colorHex.toUpperCase(); control.hexInput.classList.remove('invalid'); control.enableCheckbox.checked = savedSetting.enabled; control.ratioSlider.value = savedSetting.ratio; updateRatioDisplay(control); } }); updateAllSliderBackgrounds(); mixColorsAndUpdateUI(); }


        // --- カラーパレット関連関数 ---

        /** xterm-256color パレットのHEX値を生成またはキャッシュから取得 */
        function getXterm256HexColors() {
            if (xterm256HexCache) {
                return xterm256HexCache; // キャッシュがあれば返す
            }

            const colors = [];
            // 0-15: 標準16色
            colors.push(...[
                '#000000', '#CD0000', '#00CD00', '#CDCD00', '#0000EE', '#CD00CD', '#00CDCD', '#E5E5E5',
                '#7F7F7F', '#FF0000', '#00FF00', '#FFFF00', '#5C5CFF', '#FF00FF', '#00FFFF', '#FFFFFF'
            ]);

            // 16-231: 6x6x6 カラーキューブ
            const levels = [0, 95, 135, 175, 215, 255];
            for (let r = 0; r < 6; r++) {
                for (let g = 0; g < 6; g++) {
                    for (let b = 0; b < 6; b++) {
                        colors.push(rgbToHex(levels[r], levels[g], levels[b]));
                    }
                }
            }

            // 232-255: グレースケール (黒と白を除く)
            for (let i = 0; i < 24; i++) {
                const level = 8 + i * 10;
                colors.push(rgbToHex(level, level, level));
            }

            xterm256HexCache = colors; // 結果をキャッシュ
            return colors;
        }

        /** カラーパレットのHTMLを生成して指定グリッドに表示 */
        function renderColorPalette(gridElement, colorArray, columnClass) {
            if (!gridElement) return;
            gridElement.innerHTML = ''; // グリッドをクリア
            // ★ カラム数を設定するクラスを追加
            gridElement.className = 'palette-grid'; // 基本クラスをリセット
            if (columnClass) {
                 gridElement.classList.add(columnClass);
            }

            colorArray.forEach((hex, index) => {
                const swatchDiv = document.createElement('div');
                swatchDiv.className = 'palette-color-swatch';
                swatchDiv.style.backgroundColor = hex;
                swatchDiv.dataset.hex = hex;
                swatchDiv.title = `${hex} (Index: ${index})`; // インデックス番号も表示
                gridElement.appendChild(swatchDiv);
            });
        }

        /** パレットモーダルを開く */
        function openPaletteModal() {
            // 256色パレットを描画 (初回のみ)
            if (indexColorGrid256.childElementCount === 0) {
                 const xtermColors = getXterm256HexColors();
                 // 画面幅に応じてカラム数を決定 (例)
                 const columnClass = window.innerWidth <= 992 ? 'palette-grid-cols-12' : 'palette-grid-cols-18';
                 renderColorPalette(indexColorGrid256, xtermColors, columnClass);
            }
            // Webセーフカラーの描画 (オプション)
            // if (webSafePaletteGrid && webSafePaletteGrid.childElementCount === 0) {
            //     renderColorPalette(webSafePaletteGrid, generateWebSafeColors(), 'palette-grid-cols-18');
            // }
            colorPaletteModal.classList.add('visible');
            document.addEventListener('keydown', handleEscKey);
        }

        // --- 他のパレット/コピー関連関数 (変更なし) ---
        function closePaletteModal() { colorPaletteModal.classList.remove('visible'); document.removeEventListener('keydown', handleEscKey); }
        function handleEscKey(event) { if (event.key === 'Escape') { closePaletteModal(); } }
        async function copyToClipboard(text) { if (!navigator.clipboard) { console.warn('Clipboard API is not supported'); showCopyNotification("コピー失敗 (非対応)", true); return; } try { await navigator.clipboard.writeText(text); showCopyNotification(`Copied: ${text}`); } catch (err) { console.error('Failed to copy text: ', err); showCopyNotification("コピー失敗", true); } }
        function showCopyNotification(message, isError = false) { copyNotification.textContent = message; copyNotification.style.backgroundColor = isError ? 'rgba(220, 53, 69, 0.85)' : 'rgba(0, 0, 0, 0.75)'; copyNotification.classList.add('visible'); if (copyNotifyTimeout) { clearTimeout(copyNotifyTimeout); } copyNotifyTimeout = setTimeout(() => { copyNotification.classList.remove('visible'); copyNotifyTimeout = null; }, 2000); }


        // --- 初期化処理 (変更なし) ---
        function initialize() {
            colorControls.forEach(control => { createQuickSettingButtons(control); if (control.colorInput && control.hexInput) { control.hexInput.value = control.colorInput.value.toUpperCase(); } });
            updateAllSliderBackgrounds();
            loadSavedMixes();
            updateSavedListUI();
            mixColorsAndUpdateUI();
            if (!('EyeDropper' in window)) { console.warn("EyeDropper API はこのブラウザでサポートされていません。"); }
             pasteButtons.forEach(button => { if (!navigator.clipboard || !navigator.clipboard.readText) { button.disabled = true; button.title = "クリップボード読取非対応"; } });
             // 256色パレットを事前にキャッシュしておく (オプション)
             // getXterm256HexColors();
        }

        // --- 実行 ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>